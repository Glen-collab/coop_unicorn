<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ðŸ¦„ Unicorn Runner</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: #1a1a2e; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      min-height: 100vh;
      overflow: hidden;
      touch-action: none;
    }
    canvas { 
      border: 4px solid #333;
      border-radius: 8px;
      max-width: 100vw;
      max-height: 100vh;
    }
  </style>
</head>
<body>
  <canvas id="game" width="800" height="600"></canvas>
  <script>
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  
  // Rainbow colors for levels (ROY G BIV)
  const LEVEL_COLORS = [
    { name: 'Red', bg: '#ffcccc', ground: '#8B0000', accent: '#FF0000' },
    { name: 'Orange', bg: '#ffe6cc', ground: '#CC5500', accent: '#FF6600' },
    { name: 'Yellow', bg: '#ffffcc', ground: '#B8860B', accent: '#FFD700' },
    { name: 'Green', bg: '#ccffcc', ground: '#006400', accent: '#00FF00' },
    { name: 'Blue', bg: '#cce6ff', ground: '#00008B', accent: '#0066FF' },
    { name: 'Indigo', bg: '#d9ccff', ground: '#4B0082', accent: '#8A2BE2' },
    { name: 'Violet', bg: '#ffccff', ground: '#800080', accent: '#EE82EE' }
  ];

  // Animated butterfly sprite (6 frames, base64 encoded)
  const BUTTERFLY_SPRITE = new Image();
  BUTTERFLY_SPRITE.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAgCAYAAADtwH1UAAAAAXNSR0IArs4c6QAABZlJREFUaEPtWl1oHFUUPufO7G42m91NNpumTdK0aWxjbRFBfBBFxAcRxAd9EEXwQRB8EH8QfBAUfBBE8cEHQQQfxAdB1AdBfBBFUPDBX7SxTdI0bZpmk012Z3Z2Znbu9dyd2WR3M7ObpDbpnoeQZO6cc+/5vnvOuXdmiG7xTnfUUqPRiPm8NxC0b4mI7K9u+xAl+g0R/Z2I3p/V62+3Wi2LrqPHcCBoP5GXrm1/Q0T+Y4j9dA2M/B0i+j4R/Yk0Pd7T03PaCXTjdjuSy+fngiDYQEQbiSgkIpuIrPb3ayb0A8dxPjuay93YnJ8qYZ/neW8R0Q4iWkNEYZeAnXVJ/crzS2tra5fRIEXnOPaiPXJzJBKJDIdhy2xU1xLRaiK6goguJqKLiKifiBzHEbFo9DWns/Ntu9lsTieBZ4bDp0UQ2Nvb6wFcBxHNIaL5RNRHRBki6hME4Xs7Hv/hrl27agMqjCsJ3C1HQqG3BoaHH2qm02/7vv+J4zifhmH4+fT0dPn48ePicgKvDofjm0Kh0G1EtJyI5hCR3w4WxwN8gv6Hd9xxR/nw4cOd/f39dNNNNxl2c/s8Ik7bjcYTdH5/vyb+H0R0sO04B4PZ2f1TU1NfFQqF4yMjI7m1tTV+ww039Oy9886eG1avXui47n2NRuNeIrqGiOYRUbKdDHES+F4cj3906NAhLZlMUl9fH6dSqY7q/lRdD0R2K5H40nN0Nol4cWJiYns+n9c2b948mMlkljWbza1E9ND09PRqx3GuDsPwCiJaSEQ97STwvYyIDoRz5nz+448/arlcjgqFAp1xxhmUy+VI13Xy/frZgZf3sTc7nJO3XEwqtdtpdLwzMDBw1+Tk5KMeU3gkIvrFdd1fgtHRnz/66CNt06ZNls5sHYnYlcsJMJCPDn27sPevkc8PPPdc++2nfWdBrVa7Mzp//keJcnnr7LKyXXS9Y+/a8TFt7b9j42P+9PQWL5WaTkQij4dheBUR7SOiX8Mw/CPauPGX5557Tr/22muD4rJlVjIUqvHxYiH4bEnvL4mGaT9wlH4vc8/5Vum3o2duY/LQQJEI/X4qfJOmJWbRbLcC2OYQ0d+u634fRCI/79+/P9q/f3+07rrrotjChW4kGNSHdN2uB4E9b87cO5PZ7C4iuoKIziaidpBaQvQ7n3niQG8ul/37puu5tX0I3EpE/ySiAyJw/vzz1/Jl1xWLN+XLxe2+7z9CRDcT0aJ2kvYIvn9EJPLT7p07Kxdcfrmv1+suC3A2FNrpX3jhE/5VV7mJSMQLAr9qWVYtXN9/6+HZK74iom1EtIGIFncJWBn8vvvumcLQ8LfVq67SVi5fHvh+EGTq9eiMbYfhvb1fnfH4E6tFJLJJRK5oB4n4HN+7UVt/88m/3/VXSiSTUCaKl8tm5ODy9fuKdz/+I/cMEfWK4B4R8RxE4m/9+8LBo/MHOp9a+9fMI72bRqduM8pTd/teqYTFKIwPrBaJRQs+lhd+t//FXXtkNPRbsb+/duxYIV4s1qaOnbGt/fGTt3O77wq/P9yfwGMvv/a5c94l/34i0S2idqXJc77rOPn8ZCQSW+rn87d7YfjQ7HTh2lTZuJDqyJcDFSuFOdOcGZuzd1wqQqHLYrHkmmQ6vcpx3b+IaKfv+7snJibKV159dWH99dd3znfdFZ7nhe3k0N5+nLfJZ3Jf/Pfjf77rEjEHl8mhIuiLBOHCn3/97b8mn24sWPK1EJHviCguIoF27UqHQnMC1911TnPO/MvNaPS7eDx+KJ/Pjzuua2ia1uh96KHb/MXLD7qua4Xh/xK1+9Cg8Pqv//7P6P3/3/8BeEfL1QAAAABJRU5ErkJggg==';

  // Game state
  let game = {
    difficulty: null,
    showDifficultySelect: true,
    unicorn: { x: 80, y: 480, w: 50, h: 50, vy: 0, grounded: false, canDouble: true },
    frontFlies: [],
    rearFlies: [],
    poops: [],
    hornBlasts: [],
    pits: [],
    waterPools: [],
    poopAmmo: 5,
    maxPoop: 5,
    plugged: false,
    tootsRemaining: 0,
    hay: [],
    grain: [],
    flowers: [],
    stars: [],
    starsCollected: 0,
    flowersPooped: 0,
    butterfly: null,
    rainbowTrail: null,
    level: 0,
    killsThisLevel: 0,
    killsNeeded: [10, 15, 20, 25, 30, 35, 40],
    score: 0,
    gameOver: false,
    showSplash: false,
    splashTimer: 0,
    groundY: 530,
    scrollSpeed: 3,
    lastFrontFlySpawn: Date.now(),
    lastRearFlySpawn: Date.now(),
    lastHaySpawn: Date.now(),
    lastGrainSpawn: Date.now(),
    lastFlowerSpawn: Date.now(),
    lastStarSpawn: Date.now(),
    butterflyFrame: 0,
    butterflyAnimTimer: 0,
    lastTapTime: 0
  };

  // Difficulty settings
  const DIFFICULTY = {
    easy: { flyInterval: 3000, rearFlyInterval: 4000, flySpeed: 1.5, swarmSpeed: 0.3 },
    medium: { flyInterval: 2000, rearFlyInterval: 2500, flySpeed: 2.5, swarmSpeed: 0.5 },
    hard: { flyInterval: 1200, rearFlyInterval: 1500, flySpeed: 3.5, swarmSpeed: 0.8 }
  };

  // Sound effects (simple oscillator-based)
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSound(freq, duration, type = 'square') {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = freq;
    osc.type = type;
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  function jump() {
    if (game.gameOver || game.showDifficultySelect || game.showSplash) return;
    game.unicorn.vy = -8;
    game.unicorn.grounded = false;
    playSound(440, 0.1);
  }

  function doubleJump() {
    if (game.gameOver || game.showDifficultySelect || game.showSplash) return;
    if (game.unicorn.canDouble) {
      game.unicorn.vy = -12;
      game.unicorn.canDouble = false;
      playSound(660, 0.15);
    }
  }

  function shootPoop() {
    if (game.gameOver || game.showDifficultySelect || game.showSplash) return;
    if (game.poopAmmo > 0 && !game.plugged) {
      game.poops.push({
        x: game.unicorn.x,
        y: game.unicorn.y + game.unicorn.h / 2,
        vx: -6
      });
      game.poopAmmo--;
      playSound(150, 0.1, 'sawtooth');
    }
  }

  function shootHorn() {
    if (game.gameOver || game.showDifficultySelect || game.showSplash) return;
    game.hornBlasts.push({
      x: game.unicorn.x + game.unicorn.w,
      y: game.unicorn.y + 10,
      vx: 10,
      life: 30
    });
    playSound(880, 0.15, 'sine');
  }

  function selectDifficulty(diff) {
    game.difficulty = diff;
    game.showDifficultySelect = false;
    game.showSplash = true;
    game.splashTimer = 180;
    playSound(523, 0.1);
    playSound(659, 0.1);
    playSound(784, 0.2);
  }

  function spawnFrontFly() {
    const settings = DIFFICULTY[game.difficulty];
    game.frontFlies.push({
      x: 850,
      y: 100 + Math.random() * 350,
      w: 30,
      h: 30,
      vx: -settings.flySpeed - (game.level * 0.3)
    });
  }

  function spawnRearFly() {
    const settings = DIFFICULTY[game.difficulty];
    const angle = Math.random() * Math.PI * 2;
    game.rearFlies.push({
      x: -30,
      y: game.unicorn.y,
      w: 25,
      h: 25,
      orbitAngle: angle,
      orbitRadius: 80 + Math.random() * 40,
      orbitSpeed: settings.swarmSpeed + Math.random() * 0.2,
      swarmState: 'approaching'
    });
  }

  function spawnFlower() {
    game.flowers.push({
      x: 850,
      y: game.groundY - 20,
      w: 25,
      h: 30,
      bloomed: false
    });
  }

  function spawnStar() {
    game.stars.push({
      x: 850,
      y: 150 + Math.random() * 300,
      w: 25,
      h: 25,
      pulse: 0
    });
  }

  function spawnHay() {
    game.hay.push({ x: 850, y: game.groundY - 25, w: 30, h: 25 });
  }

  function spawnGrain() {
    game.grain.push({ x: 850, y: game.groundY - 20, w: 20, h: 20 });
  }

  function activateButterfly() {
    game.butterfly = {
      x: game.unicorn.x - 50,
      y: game.unicorn.y - 30,
      targetFly: null,
      attackStartTime: null,
      expiresAt: Date.now() + 25000,
      returning: false
    };
    game.flowersPooped = 0;
    playSound(1047, 0.2, 'sine');
    playSound(1319, 0.2, 'sine');
  }

  function activateRainbowTrail() {
    game.rainbowTrail = {
      expiresAt: Date.now() + 10000,
      particles: []
    };
    game.starsCollected = 0;
    playSound(523, 0.1, 'sine');
    playSound(659, 0.1, 'sine');
    playSound(784, 0.1, 'sine');
    playSound(1047, 0.2, 'sine');
  }

  function update() {
    if (game.showDifficultySelect || game.showSplash || game.gameOver) return;

    const settings = DIFFICULTY[game.difficulty];
    const now = Date.now();

    // Gravity and unicorn physics
    game.unicorn.vy += 0.4;
    game.unicorn.y += game.unicorn.vy;
    
    if (game.unicorn.y >= game.groundY - game.unicorn.h) {
      game.unicorn.y = game.groundY - game.unicorn.h;
      game.unicorn.vy = 0;
      game.unicorn.grounded = true;
      game.unicorn.canDouble = true;
    }

    if (game.unicorn.y < 0) {
      game.unicorn.y = 0;
      game.unicorn.vy = 0;
    }

    // Spawning
    if (now - game.lastFrontFlySpawn > settings.flyInterval) {
      spawnFrontFly();
      game.lastFrontFlySpawn = now;
    }

    if (now - game.lastRearFlySpawn > settings.rearFlyInterval) {
      spawnRearFly();
      game.lastRearFlySpawn = now;
    }

    if (now - game.lastFlowerSpawn > 4000) {
      spawnFlower();
      game.lastFlowerSpawn = now;
    }

    if (now - game.lastStarSpawn > 6000) {
      spawnStar();
      game.lastStarSpawn = now;
    }

    if (now - game.lastHaySpawn > 8000) {
      spawnHay();
      game.lastHaySpawn = now;
    }

    if (now - game.lastGrainSpawn > 10000) {
      spawnGrain();
      game.lastGrainSpawn = now;
    }

    // Update front flies
    game.frontFlies = game.frontFlies.filter(fly => {
      fly.x += fly.vx;
      return fly.x > -50;
    });

    // Update rear flies (swarming behavior)
    game.rearFlies = game.rearFlies.filter(fly => {
      if (fly.swarmState === 'approaching') {
        const dx = game.unicorn.x - fly.x;
        const dy = game.unicorn.y - fly.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist > fly.orbitRadius) {
          fly.x += (dx / dist) * 2;
          fly.y += (dy / dist) * 2;
        } else {
          fly.swarmState = 'orbiting';
        }
      } else {
        fly.orbitAngle += fly.orbitSpeed * 0.05;
        fly.x = game.unicorn.x + Math.cos(fly.orbitAngle) * fly.orbitRadius;
        fly.y = game.unicorn.y + Math.sin(fly.orbitAngle) * fly.orbitRadius;
      }
      return true;
    });

    // Update poops
    game.poops = game.poops.filter(poop => {
      poop.x += poop.vx;
      
      // Check collision with rear flies
      game.rearFlies = game.rearFlies.filter(fly => {
        if (poop.x < fly.x + fly.w && poop.x + 15 > fly.x &&
            poop.y < fly.y + fly.h && poop.y + 15 > fly.y) {
          game.score += 10;
          game.killsThisLevel++;
          playSound(300, 0.1);
          return false;
        }
        return true;
      });

      // Check collision with flowers
      game.flowers.forEach(flower => {
        if (!flower.bloomed && 
            poop.x < flower.x + flower.w && poop.x + 15 > flower.x &&
            poop.y < flower.y + flower.h && poop.y + 15 > flower.y) {
          flower.bloomed = true;
          game.flowersPooped++;
          playSound(600, 0.1, 'sine');
          if (game.flowersPooped >= 5 && !game.butterfly) {
            activateButterfly();
          }
        }
      });

      return poop.x > -20;
    });

    // Update horn blasts
    game.hornBlasts = game.hornBlasts.filter(blast => {
      blast.x += blast.vx;
      blast.life--;

      // Check collision with front flies
      game.frontFlies = game.frontFlies.filter(fly => {
        if (blast.x < fly.x + fly.w && blast.x + 40 > fly.x &&
            blast.y < fly.y + fly.h && blast.y + 20 > fly.y) {
          game.score += 15;
          game.killsThisLevel++;
          playSound(500, 0.1);
          return false;
        }
        return true;
      });

      return blast.life > 0 && blast.x < 850;
    });

    // Update flowers
    game.flowers = game.flowers.filter(flower => {
      flower.x -= game.scrollSpeed;
      
      // Collect bloomed flowers
      if (flower.bloomed) {
        const dx = game.unicorn.x + game.unicorn.w/2 - flower.x;
        const dy = game.unicorn.y + game.unicorn.h/2 - flower.y;
        if (Math.sqrt(dx*dx + dy*dy) < 40) {
          playSound(800, 0.1, 'sine');
          return false;
        }
      }
      return flower.x > -30;
    });

    // Update stars
    game.stars = game.stars.filter(star => {
      star.x -= game.scrollSpeed;
      star.pulse += 0.1;

      const dx = game.unicorn.x + game.unicorn.w/2 - star.x;
      const dy = game.unicorn.y + game.unicorn.h/2 - star.y;
      if (Math.sqrt(dx*dx + dy*dy) < 35) {
        game.starsCollected++;
        game.score += 5;
        playSound(1000, 0.1, 'sine');
        if (game.starsCollected >= 5 && !game.rainbowTrail) {
          activateRainbowTrail();
        }
        return false;
      }
      return star.x > -30;
    });

    // Update hay and grain
    game.hay = game.hay.filter(h => {
      h.x -= game.scrollSpeed;
      const dx = game.unicorn.x - h.x;
      const dy = game.unicorn.y - h.y;
      if (Math.abs(dx) < 40 && Math.abs(dy) < 40) {
        game.poopAmmo = Math.min(game.maxPoop, game.poopAmmo + 2);
        playSound(400, 0.1);
        return false;
      }
      return h.x > -30;
    });

    game.grain = game.grain.filter(g => {
      g.x -= game.scrollSpeed;
      const dx = game.unicorn.x - g.x;
      const dy = game.unicorn.y - g.y;
      if (Math.abs(dx) < 35 && Math.abs(dy) < 35) {
        if (game.plugged) {
          game.plugged = false;
          game.tootsRemaining = 3;
        }
        playSound(600, 0.1);
        return false;
      }
      return g.x > -30;
    });

    // Update butterfly
    if (game.butterfly) {
      game.butterflyAnimTimer++;
      if (game.butterflyAnimTimer >= 6) {
        game.butterflyFrame = (game.butterflyFrame + 1) % 6;
        game.butterflyAnimTimer = 0;
      }

      if (now > game.butterfly.expiresAt) {
        game.butterfly = null;
      } else if (!game.butterfly.targetFly && game.rearFlies.length > 0) {
        // Find oldest fly
        game.butterfly.targetFly = game.rearFlies[0];
        game.butterfly.attackStartTime = now;
      } else if (game.butterfly.targetFly) {
        // Move toward target
        const dx = game.butterfly.targetFly.x - game.butterfly.x;
        const dy = game.butterfly.targetFly.y - game.butterfly.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist > 5) {
          game.butterfly.x += (dx / dist) * 4;
          game.butterfly.y += (dy / dist) * 4;
        }

        // Kill after 2 seconds
        if (now - game.butterfly.attackStartTime > 2000) {
          game.rearFlies = game.rearFlies.filter(f => f !== game.butterfly.targetFly);
          game.score += 10;
          game.killsThisLevel++;
          game.butterfly.targetFly = null;
          game.butterfly.returning = true;
          playSound(700, 0.15, 'sine');
        }
      } else {
        // Return to unicorn
        const dx = (game.unicorn.x - 50) - game.butterfly.x;
        const dy = (game.unicorn.y - 30) - game.butterfly.y;
        game.butterfly.x += dx * 0.1;
        game.butterfly.y += dy * 0.1;
        game.butterfly.returning = false;
      }
    }

    // Update rainbow trail
    if (game.rainbowTrail) {
      if (now > game.rainbowTrail.expiresAt) {
        game.rainbowTrail = null;
      } else {
        // Add trail particle
        game.rainbowTrail.particles.push({
          x: game.unicorn.x,
          y: game.unicorn.y + game.unicorn.h / 2,
          life: 30,
          color: ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#9400D3'][Math.floor(Math.random() * 7)]
        });

        // Update particles
        game.rainbowTrail.particles = game.rainbowTrail.particles.filter(p => {
          p.x -= 2;
          p.life--;
          return p.life > 0;
        });

        // Kill rear flies that touch trail
        game.rearFlies = game.rearFlies.filter(fly => {
          for (let p of game.rainbowTrail.particles) {
            const dx = fly.x - p.x;
            const dy = fly.y - p.y;
            if (Math.sqrt(dx*dx + dy*dy) < 25) {
              game.score += 10;
              game.killsThisLevel++;
              playSound(600, 0.1);
              return false;
            }
          }
          return true;
        });
      }
    }

    // Check collisions with flies
    for (let fly of [...game.frontFlies, ...game.rearFlies]) {
      const dx = game.unicorn.x + game.unicorn.w/2 - (fly.x + fly.w/2);
      const dy = game.unicorn.y + game.unicorn.h/2 - (fly.y + fly.h/2);
      if (Math.sqrt(dx*dx + dy*dy) < 30) {
        game.gameOver = true;
        playSound(200, 0.3, 'sawtooth');
      }
    }

    // Level progression
    if (game.killsThisLevel >= game.killsNeeded[game.level]) {
      if (game.level < 6) {
        game.level++;
        game.killsThisLevel = 0;
        game.showSplash = true;
        game.splashTimer = 180;
        game.frontFlies = [];
        game.rearFlies = [];
        playSound(523, 0.1);
        playSound(659, 0.1);
        playSound(784, 0.2);
      } else {
        // Win!
        game.gameOver = true;
      }
    }
  }

  function draw() {
    const levelColor = LEVEL_COLORS[game.level];
    
    // Draw difficulty select screen
    if (game.showDifficultySelect) {
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, 800, 600);

      // Title
      ctx.fillStyle = '#FFD700';
      ctx.font = 'bold 48px Georgia';
      ctx.textAlign = 'center';
      ctx.fillText('ðŸ¦„ UNICORN RUNNER ðŸ¦„', 400, 120);

      // Difficulty buttons
      const buttons = [
        { text: 'EASY', y: 220, color: '#00FF00', diff: 'easy' },
        { text: 'MEDIUM', y: 320, color: '#FFFF00', diff: 'medium' },
        { text: 'HARD', y: 420, color: '#FF0000', diff: 'hard' }
      ];

      buttons.forEach(btn => {
        ctx.fillStyle = '#333';
        ctx.fillRect(250, btn.y, 300, 70);
        ctx.strokeStyle = btn.color;
        ctx.lineWidth = 4;
        ctx.strokeRect(250, btn.y, 300, 70);
        ctx.fillStyle = btn.color;
        ctx.font = 'bold 32px Georgia';
        ctx.fillText(btn.text, 400, btn.y + 48);
      });

      ctx.fillStyle = '#888';
      ctx.font = '18px Georgia';
      ctx.fillText('Click or tap to select difficulty', 400, 530);
      return;
    }

    // Draw splash screen
    if (game.showSplash) {
      game.splashTimer--;
      ctx.fillStyle = levelColor.bg;
      ctx.fillRect(0, 0, 800, 600);

      // Tecmo Bowl style portrait frame
      ctx.fillStyle = levelColor.ground;
      ctx.fillRect(250, 150, 300, 250);
      ctx.strokeStyle = '#FFD700';
      ctx.lineWidth = 6;
      ctx.strokeRect(250, 150, 300, 250);

      // Unicorn portrait
      ctx.font = '120px Georgia';
      ctx.textAlign = 'center';
      ctx.fillText('ðŸ¦„', 400, 320);

      // Level text
      ctx.fillStyle = levelColor.accent;
      ctx.font = 'bold 48px Georgia';
      ctx.fillText(`LEVEL ${game.level + 1}`, 400, 460);
      ctx.fillStyle = '#FFF';
      ctx.font = 'bold 36px Georgia';
      ctx.fillText(levelColor.name.toUpperCase(), 400, 510);

      if (game.splashTimer <= 0) {
        game.showSplash = false;
      }
      return;
    }

    // Game over screen
    if (game.gameOver) {
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, 800, 600);
      ctx.fillStyle = game.level >= 6 ? '#FFD700' : '#FF0000';
      ctx.font = 'bold 48px Georgia';
      ctx.textAlign = 'center';
      ctx.fillText(game.level >= 6 ? 'ðŸŽ‰ YOU WIN! ðŸŽ‰' : 'GAME OVER', 400, 250);
      ctx.fillStyle = '#FFF';
      ctx.font = '32px Georgia';
      ctx.fillText(`Score: ${game.score}`, 400, 320);
      ctx.fillText(`Level: ${game.level + 1}`, 400, 370);
      ctx.font = '24px Georgia';
      ctx.fillText('Tap or click to restart', 400, 450);
      return;
    }

    // Draw game
    ctx.fillStyle = levelColor.bg;
    ctx.fillRect(0, 0, 800, 600);

    // Ground
    ctx.fillStyle = levelColor.ground;
    ctx.fillRect(0, game.groundY, 800, 70);

    // Rainbow trail particles
    if (game.rainbowTrail) {
      game.rainbowTrail.particles.forEach(p => {
        ctx.globalAlpha = p.life / 30;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.globalAlpha = 1;
    }

    // Flowers
    game.flowers.forEach(flower => {
      if (flower.bloomed) {
        ctx.fillStyle = '#FF69B4';
        ctx.font = '28px Georgia';
        ctx.fillText('ðŸŒ¸', flower.x, flower.y + 20);
      } else {
        ctx.fillStyle = '#8B4513';
        ctx.font = '28px Georgia';
        ctx.fillText('ðŸ¥€', flower.x, flower.y + 20);
      }
    });

    // Stars
    game.stars.forEach(star => {
      ctx.save();
      ctx.translate(star.x + star.w/2, star.y + star.h/2);
      ctx.scale(1 + Math.sin(star.pulse) * 0.2, 1 + Math.sin(star.pulse) * 0.2);
      ctx.font = '24px Georgia';
      ctx.textAlign = 'center';
      ctx.fillText('â­', 0, 8);
      ctx.restore();
    });

    // Hay and grain
    game.hay.forEach(h => {
      ctx.fillStyle = '#DAA520';
      ctx.font = '28px Georgia';
      ctx.fillText('ðŸŒ¾', h.x, h.y + 20);
    });
    game.grain.forEach(g => {
      ctx.fillStyle = '#F5DEB3';
      ctx.font = '24px Georgia';
      ctx.fillText('ðŸŒ°', g.x, g.y + 16);
    });

    // Unicorn
    ctx.font = '48px Georgia';
    ctx.fillText('ðŸ¦„', game.unicorn.x, game.unicorn.y + 45);

    // Butterfly (animated)
    if (game.butterfly) {
      ctx.save();
      ctx.translate(game.butterfly.x, game.butterfly.y);
      
      // Draw butterfly sprite
      const frameWidth = 32;
      ctx.drawImage(
        BUTTERFLY_SPRITE,
        game.butterflyFrame * frameWidth, 0,
        frameWidth, 32,
        -16, -16,
        32, 32
      );
      ctx.restore();
    }

    // Front flies
    game.frontFlies.forEach(fly => {
      ctx.font = '28px Georgia';
      ctx.fillText('ðŸª°', fly.x, fly.y + 20);
    });

    // Rear flies (swarm)
    game.rearFlies.forEach(fly => {
      ctx.font = '24px Georgia';
      ctx.fillText('ðŸª°', fly.x, fly.y + 18);
    });

    // Poops
    game.poops.forEach(poop => {
      ctx.font = '20px Georgia';
      ctx.fillText('ðŸ’©', poop.x, poop.y + 12);
    });

    // Horn blasts
    game.hornBlasts.forEach(blast => {
      ctx.fillStyle = `rgba(255, 215, 0, ${blast.life / 30})`;
      ctx.beginPath();
      ctx.moveTo(blast.x, blast.y);
      ctx.lineTo(blast.x + 40, blast.y + 10);
      ctx.lineTo(blast.x, blast.y + 20);
      ctx.fill();
    });

    // HUD
    ctx.fillStyle = '#333';
    ctx.fillRect(10, 10, 200, 100);
    ctx.strokeStyle = levelColor.accent;
    ctx.lineWidth = 2;
    ctx.strokeRect(10, 10, 200, 100);

    ctx.fillStyle = '#FFF';
    ctx.font = '16px Georgia';
    ctx.textAlign = 'left';
    ctx.fillText(`Score: ${game.score}`, 20, 35);
    ctx.fillText(`Level: ${game.level + 1} (${levelColor.name})`, 20, 55);
    ctx.fillText(`Kills: ${game.killsThisLevel}/${game.killsNeeded[game.level]}`, 20, 75);
    ctx.fillText(`Poop: ${'ðŸ’©'.repeat(game.poopAmmo)}`, 20, 95);

    // Power-up indicators
    ctx.textAlign = 'right';
    if (game.butterfly) {
      const timeLeft = Math.ceil((game.butterfly.expiresAt - Date.now()) / 1000);
      ctx.fillStyle = '#FF69B4';
      ctx.fillText(`ðŸ¦‹ ${timeLeft}s`, 780, 35);
    }
    if (game.rainbowTrail) {
      const timeLeft = Math.ceil((game.rainbowTrail.expiresAt - Date.now()) / 1000);
      ctx.fillStyle = '#FFD700';
      ctx.fillText(`ðŸŒˆ ${timeLeft}s`, 780, 55);
    }
    ctx.fillStyle = '#FFF';
    ctx.fillText(`â­ ${game.starsCollected}/5`, 780, 75);
    ctx.fillText(`ðŸŒ¸ ${game.flowersPooped}/5`, 780, 95);

    // Mobile controls hint
    ctx.textAlign = 'center';
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.font = '14px Georgia';
    ctx.fillText('TAP=Jump | SWIPE â†=Poop | SWIPE â†’=Horn', 400, 590);
  }

  function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
  }

  function resetGame() {
    game = {
      difficulty: null,
      showDifficultySelect: true,
      unicorn: { x: 80, y: 480, w: 50, h: 50, vy: 0, grounded: false, canDouble: true },
      frontFlies: [],
      rearFlies: [],
      poops: [],
      hornBlasts: [],
      pits: [],
      waterPools: [],
      poopAmmo: 5,
      maxPoop: 5,
      plugged: false,
      tootsRemaining: 0,
      hay: [],
      grain: [],
      flowers: [],
      stars: [],
      starsCollected: 0,
      flowersPooped: 0,
      butterfly: null,
      rainbowTrail: null,
      level: 0,
      killsThisLevel: 0,
      killsNeeded: [10, 15, 20, 25, 30, 35, 40],
      score: 0,
      gameOver: false,
      showSplash: false,
      splashTimer: 0,
      groundY: 530,
      scrollSpeed: 3,
      lastFrontFlySpawn: Date.now(),
      lastRearFlySpawn: Date.now(),
      lastHaySpawn: Date.now(),
      lastGrainSpawn: Date.now(),
      lastFlowerSpawn: Date.now(),
      lastStarSpawn: Date.now(),
      butterflyFrame: 0,
      butterflyAnimTimer: 0,
      lastTapTime: 0
    };
  }

  // Input handling
  let touchStartX = 0;
  let touchStartY = 0;

  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  });

  canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    const dx = touchEndX - touchStartX;
    const dy = touchEndY - touchStartY;

    // Handle difficulty selection
    if (game.showDifficultySelect) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (touchEndX - rect.left) * scaleX;
      const y = (touchEndY - rect.top) * scaleY;

      if (x >= 250 && x <= 550) {
        if (y >= 220 && y <= 290) selectDifficulty('easy');
        else if (y >= 320 && y <= 390) selectDifficulty('medium');
        else if (y >= 420 && y <= 490) selectDifficulty('hard');
      }
      return;
    }

    if (game.gameOver) {
      resetGame();
      return;
    }

    if (game.showSplash) return;

    if (dx < -50) {
      shootPoop();
    } else if (dx > 50) {
      shootHorn();
    } else if (Math.abs(dx) < 30 && Math.abs(dy) < 30) {
      const now = Date.now();
      if (now - game.lastTapTime < 300) {
        doubleJump();
        game.lastTapTime = 0;
      } else {
        jump();
        game.lastTapTime = now;
      }
    }
  });

  canvas.addEventListener('click', (e) => {
    if (game.showDifficultySelect) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;

      if (x >= 250 && x <= 550) {
        if (y >= 220 && y <= 290) selectDifficulty('easy');
        else if (y >= 320 && y <= 390) selectDifficulty('medium');
        else if (y >= 420 && y <= 490) selectDifficulty('hard');
      }
      return;
    }

    if (game.gameOver) {
      resetGame();
      return;
    }

    if (!game.showSplash) {
      jump();
    }
  });

  document.addEventListener('keydown', (e) => {
    if (game.showDifficultySelect) {
      if (e.key === '1') selectDifficulty('easy');
      else if (e.key === '2') selectDifficulty('medium');
      else if (e.key === '3') selectDifficulty('hard');
      return;
    }

    if (game.gameOver) {
      resetGame();
      return;
    }

    if (game.showSplash) return;

    if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'w') {
      jump();
    } else if (e.key === 'ArrowDown' || e.key === 's') {
      doubleJump();
    } else if (e.key === 'a' || e.key === 'ArrowLeft') {
      shootPoop();
    } else if (e.key === 'd' || e.key === 'ArrowRight') {
      shootHorn();
    }
  });

  // Start game loop
  loop();
  </script>
</body>
</html>
